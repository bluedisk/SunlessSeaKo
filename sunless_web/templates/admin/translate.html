{% extends "admin/change_form.html" %}
{% load i18n admin_urls %}

{% block extrastyle %}
    {{ block.super }}
    <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap/dist/css/bootstrap.min.css"/>
    <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css"/>


    <link type="text/css" rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
    <link type="text/css" rel="stylesheet" href="/static/jquery-mentions/jquery.mentions.css"/>
{% endblock %}

{% block content %}
    <h2>Path: {{ adminform.form.instance.name }}</h2><br/>
    {% verbatim %}
    <div id="app">
        <b-card-group deck>
            <entry v-for="entry in entries" :key="entry.pk" :data="entry"></entry>
        </b-card-group>
    </div>
    {% endverbatim %}

{% endblock %}
{% block footer %}
    {{ block.super }}

    {% verbatim %}
    <script id="template-entry" type="template/vuejs">
        <b-card>
            <h6 slot="header" class="mb-0 text-gray-dark">#{{ data.id }} / {{ data.object }}</h6>

            <div class="mb-3"><strong>원문</strong><br/>{{ data.text_en }}<br/></div>
            <div class="mb-3" v-if="data.text_jpkr"><strong>일본어</strong><br/> {{ data.text_jpkr }}<br/></div>
            <div class="mb-3" v-if="data.text_pp"><strong>파파고</strong><br/> <span v-html="data.text_pp"></span><br/>
            </div>
            <hr/>

            <div class="">
                <h5>번역</h5>
                <translate v-for="trans in data.translations" :key="trans.pk" :data="trans"></translate>
                <p v-if="!data.translations.length" class="text-muted">## 번역이 없습니다 ##</p>
                <comment-box text="번역 추가하기" is-mention="true" post-type="translate" @upload="postComment"></comment-box>
            </div>
            <hr/>
            <div>
                <h5>의견</h5>
                <discuss v-for="discuss in data.discusses" :key="discuss.pk" :data="discuss"></discuss>
                <p v-if="!data.discusses.length" class="text-muted">## 의견이 없습니다 ##</p>
                <comment-box text="의견 추가하기" is-mention="false" post-type="discuss" @upload="postComment"></comment-box>
            </div>

        </b-card>
    </script>
    <script id="template-discuss" type="template/vuejs">
        <div class="mb-1">

            <span class="mb-0 discuss-name"><strong>{{ data.user }}</strong></span>
            <b-badge variant="light">{{ data.created_at }}</b-badge>
            <likes :likes="data.likes" type="discuss" :pk="data.pk"></likes>

            <div class="mb-3">
                <span>#{{ data.translate }}</span>
                <span class="discuss-msg">{{ data.msg }}</span>
            </div>
        </div>
    </script>
    <script id="template-trans" type="template/vuejs">
        <div class="mb-1">

            <b-badge variant="secondary">#{{ data.pk }}</b-badge>
            <span v-if="data.user != 'unknown'"><strong>{{ data.user }}</strong></span>
            <b-badge variant="light">{{ data.created_at }}</b-badge>
            <likes :likes="data.likes" type="trans" :pk="data.pk"></likes>

            <div class="mt-1 mb-3">
                <span v-html="data.text"></span>
            </div>
        </div>
    </script>
    <script id="template-likes" type="template/vuejs">
        <div class="float-right mt-2">
            <b-button size="sm" :variant="this.variant" @click.prevent="toggle">좋아요
                <b-badge variant="light">
                    {{ this.count }} <span class="sr-only">liked</span>
                </b-badge>
            </b-button>
        </div>
    </script>
    <script id="template-comment-box" type="template/vuejs">
        <div class="clearfix">
            <b-form-group>
                <textarea :class="{'form-control': true, mentions: isMention, 'js-elasticArea':true}" v-model="content"
                          placeholder="Enter new translation"></textarea>
            </b-form-group>
            <b-button variant="outline-primary" class="float-right" @click.prevent="upload">{{ this.text }}</b-button>
        </div>
    </script>

    {% endverbatim %}

    <script src="//cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="//unpkg.com/babel-polyfill@latest/dist/polyfill.min.js"></script>
    <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
    <script src="//unpkg.com/axios/dist/axios.min.js"></script>

    <script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="//code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="/static/jquery-mentions/jquery.mentions.js"></script>
    <script src="/static/js/translate.js"></script>
    <script src="/static/js/elastic.js"></script>

    <script language="javascript">
        var userPk = {{ user.pk }};

        /* global Vue */
        Vue.component('entry', {
            props: ['data'],
            template: document.getElementById('template-entry').innerText,
            methods: {
                postComment: function (content) {
                    console.log("postComment!");
                    console.log(this.data.id);

                    var entry = this;

                    axios.post("/" + ["api", "post", this.data.id].join("/") + "/", content)
                        .then(function (res) {
                            console.log("post comment result");

                            if ( res.status === 200 ) {
                                entry.data.translations = res.data.translations;
                                entry.data.discusses = res.data.discusses;
                            } else {
                                console.error(res);
                            }
                        })
                        .catch(function (error) {
                            console.error(error);
                        });
                }
            }
        });

        Vue.component('translate', {
            props: ['data'],
            template: document.getElementById('template-trans').innerText
        });

        Vue.component('discuss', {
            props: ['data'],
            template: document.getElementById('template-discuss').innerText
        });

        Vue.component('likes', {
            props: ['likes', 'type', 'pk'],
            data: function () {
                return {
                    likesProxy: this.likes.slice()
                }
            },
            computed: {
                variant: function () {
                    if (this.likesProxy.indexOf(userPk) !== -1) return 'outline-primary';
                    return 'primary';
                },
                count: function () {
                    return this.likesProxy.length
                }
            },
            template: document.getElementById('template-likes').innerText,
            methods: {
                toggle: function () {
                    var action = "like";
                    if (this.likesProxy.indexOf(userPk) !== -1) action = "unlike";

                    var parent = this;
                    axios.get("/" + ["api", "like", action, this.type, this.pk].join("/") + "/")
                        .then(function (res) {
                            parent.likesProxy = res.data;
                        })
                        .catch(function (error) {
                            console.error(error);
                        });
                }
            }
        });

        Vue.component('comment-box', {
            props: ['text', 'isMention', 'postType'],
            data: function () {
                return {
                    content: ''
                }
            },
            template: document.getElementById('template-comment-box').innerText,
            methods: {
                upload: function () {
                    this.$emit('upload', {
                        postType: this.postType,
                        postData: this.content
                    });
                }
            }
        });

        new Vue({
            el: '#app',
            data: {
                entries: {{ adminform.form.instance.to_json_text }}
            }
        });

    </script>

{% endblock %}